<!doctype html>

<html lang="en">

<head>
	<meta charset="utf-8">
	<title>SPACE INVADERS</title>
	<style>
		pre {
			position: absolute;
			left: 50%;
			top: 50%;
			-webkit-transform: translate(-50%, -50%);
			transform: translate(-50%, -50%);
			border: 1px solid gray;
		}

		body {
			color: white;
			background-color: black;
		}
	</style>
</head>

<body>
	<pre id="console">
  	<!-- Hier landet später der Output aus Javascript -->
  </pre>
	<script src="invader_class.js"></script>
	<script src="InvaderRow.js"></script>
	<script>
		let renderStr = "";
		let rows = 50;
		let cols = 140;
		let xpos = Math.floor(Math.random() * (cols / 2));
		let ypos = 5;
		let cnt = 0;
		let spaceshipPos = Math.round(cols / 2);
		let currentBullets = [];
		let currentInvaderBullets = [];
		let invaders = [];
		let obstacles = [];
		let run = 0;
		let xoffset = 0;
		let yoffset = 0;
		let invadersPos = 0;
		let right = true;
		let pause = false;
		const temp = new invaderRow(5, 5, cols, 5, 1, 5, 5, Math.random());
		/*
		 *	SPIELELOGIK
		 */
		//Kugel abfeuern
		function newGame() {
			//TODO Punktestände

			//TODO Invaders erzeugen und in Array (invaders) schreiben damit sie gerendet werden können
			invaders.push(new Invader(5, 5, 10, 10, 1));
			//Obstacles erzeugen
			obstacles.push({
				x: Math.round(cols / 2) - 5,
				y: rows - 10,
				width: 10,
				height: 3,
				char: "*"
			})
		}

		function fireBullet() {
			currentBullets.push({
				x: spaceshipPos + 3,
				y: rows - 4
			});
		}

		/*
		function generateInvader() {
			let invader = [];
			for (let x = 0; x < 10; x++) {
				invader[x] = [];
				for (let y = 0; y < 5; y++) {
					const random = Math.random();
					if (random < 0.5) {

						invader[x][y] = 1

					} else {
						invader[x][y] = 0
					}

				}


			}
			// console.log(invader)
			return invader;
		}
		*/



		/*
		 *	HELFERFUNKTIONEN
		 */
		//Characters in String editieren
		function setCharsAt(str, index, chr) {
			if (index > str.length - 1) return str;
			return str.substr(0, index) + chr + str.substr(index + chr.length);
		}

		//X/Y-Wert in fortlaufende String-Position umwandeln
		function xyToStringPos(posX, posY) {
			//Zusätzliche Characters wegen Zeilenumbrüchen
			let rowOffset = posY;
			//Position im Gesamtstring, (AnzahlZeilen/YPos+i)*ZeichenProZeile plus rowOffset plus momentan gezeichnete Zeile des Ships
			let posInString = posY * cols + rowOffset + posX;
			return posInString;
		}

		//Spieler-Interaktionen verschicken
		document.addEventListener('keydown', (event) => {
			const keyCode = event.keyCode;

			if (keyCode === 37) {
				//Linke Pfeiltaste - Spaceship nach links bewegen
				spaceshipPos = Math.max(0, spaceshipPos - 1);
			} else if (keyCode === 39) {
				//Rechte Pfeiltaste - Spaceship nach rechts bewegen
				spaceshipPos = Math.min(cols - 7, spaceshipPos + 1);
			} else if (keyCode === 32) {
				//Leertase - Feuer!
				fireBullet();
			} else if (keyCode === 69) {
				//e - test explodieren invader
				invaders[0].explode();
			} else if (keyCode === 80) {
				pause = !pause;
			}
		}, false);


		/*
		 * RENDERFUNKTIONEN
		 */
		function renderBackground(rows, cols) {
			//console.log("render "+cnt)
			let str = ""
			for (var i = 0; i < rows; i++) {
				for (var j = 0; j < cols; j++) {
					if (i == cnt + Math.round(Math.random() * 80)) str += "`"
					else str += " "
				}
				str += "\n"
			}
			cnt++;
			if (cnt * 6 > rows * 0.2) cnt = 0;
			return str;
		}

		function renderSpaceship(posX, posY) {
			//Spaceship-Array
			let spaceship = ["   ¡   ",
				"╔▒▒▒▒▒╗",
				"╚▒▒▒▒▒╝"
			]
			for (var i = 0; i < spaceship.length; i++) {
				//Zeilenweise in String schreiben
				renderStr = setCharsAt(renderStr, xyToStringPos(posX, posY + i), spaceship[i]);
			}
		}

		function renderObstacles() {
			obstacles.forEach((obstacle) => {
				for (var i = 0; i < obstacle.height; i++) {
					//Zeilenweise in String schreiben
					renderStr = setCharsAt(renderStr, xyToStringPos(obstacle.x, obstacle.y + i), obstacle.char.repeat(obstacle
						.width));
				}
			});
		}

		function renderBullets() {
			//TODO: Prüfen ob eine Kugel einen Invader oder ein Obstacle trifft, wenn ja Aktion auslösen

			//Kugeln entfernen die am oberen Rand angekommen sind ohne Treffer
			currentBullets = currentBullets.filter(bullet => bullet.y > 1);
			//Kugeln einen Schritt weiter bewegen, dann rendern
			currentBullets.forEach((bullet) => {
				bullet.y -= 1;
				renderStr = setCharsAt(renderStr, xyToStringPos(bullet.x, bullet.y), "|");
			})
		}

		function renderInvaders(invader, pos) {
			//TODO Invaders rendern
			run++;
			if (run >= 5) {
				run = 0; //	xoffset += 2;
				if (right) {
					xoffset += 5;
				} else {
					xoffset -= 5;
				}

				for (let i = 0; i < invaders.length; i++) {
					invader = invaders[i];
					if (invader.explodeState > 0) {
						invader.explodeState += 1;
						if (right) {
							xoffset -= 5;
						} else {
							xoffset += 5;
						}
					}
					//let limitX = cols - invader.appearance.length * 2;
					let limitX = cols - temp.rowWidth;
					let limitY = rows - invader.appearance[0].length - 5;
					if (invader.posY + yoffset <= limitY) {
						if (invader.posX + xoffset >= limitX) {
							right = false;
							yoffset++;
						} else if (invader.posX + xoffset <= 0) {
							right = true;
							yoffset++;
						}
					} else {
						xoffset = 0;
						yoffset = 0;
					}
				}
			}
			/*for (let i = 0; i < invaders.length; i++) {
				printInvader(invaders[i]);
			}*/
			
				printInvaderRow(temp);
		}
		

		function printInvader(invader) {
			for (let x = 0; x < invader.appearance[0].length; x++) {
				for (let y = 0; y < invader.appearance.length; y++) {
					if (invader.explodeState < 5) {
						if (invader.appearance[x][y] == 1) {

							renderStr = setCharsAt(renderStr, xyToStringPos(x + invader.posX + xoffset, y + invader.posY + yoffset),
								'█');
							renderStr = setCharsAt(renderStr, xyToStringPos(invader.appearance.length * 2 - x + invader.posX + xoffset,
								y + invader.posY + yoffset), '█');
							//renderStr = setCharsAt(renderStr,xyToStringPos (x+ xpos,y+ypos), "ABC")
						} else if (invader.appearance[x][y] == 2) {
							renderStr = setCharsAt(renderStr, xyToStringPos(x + invader.posX + xoffset, y + invader.posY + yoffset),
								'*');
							renderStr = setCharsAt(renderStr, xyToStringPos(invader.appearance.length * 2 - x + invader.posX + xoffset,
								y + invader.posY + yoffset), '*');
						}
					}
				}
			}
		}

		function printInvaderRow(invaderRow) {
			for (let i = 0; i < invaderRow.invaders.length; i++) {
				for (let x = 0; x < invaderRow.invaders[i].appearance[0].length; x++) {
					for (let y = 0; y < invaderRow.invaders[i].appearance.length; y++) {
						if (invaderRow.invaders[i].explodeState < 5) {
							if (invaderRow.invaders[i].appearance[x][y] == 1) {

								renderStr = setCharsAt(renderStr, xyToStringPos(x + invaderRow.invaders[i].posX + xoffset, y + invaderRow
										.invaders[i].posY + yoffset),
									'█');
								renderStr = setCharsAt(renderStr, xyToStringPos(invaderRow.invaders[i].appearance.length * 2 - x +
									invaderRow.invaders[i].posX + xoffset,
									y + invaderRow.invaders[i].posY + yoffset), '█');
								//renderStr = setCharsAt(renderStr,xyToStringPos (x+ xpos,y+ypos), "ABC")
							} else if (invaderRow.invaders[i].appearance[x][y] == 2) {
								renderStr = setCharsAt(renderStr, xyToStringPos(x + invaderRow.invaders[i].posX + xoffset, y + invaderRow
										.invader[i].posY + yoffset),
									'*');
								renderStr = setCharsAt(renderStr, xyToStringPos(invaderRow.invaders[i].appearance.length * 2 - x +
									invaderRow.invaders[i].posX + xoffset,
									y + invaderRow.invaders[i].posY + yoffset), '*');
							}
						}
					}
				}
			}
		}


		//Hauptrenderfunktion
		function render() {
			if (!pause) {


				//Render Background
				renderStr = renderBackground(rows, cols);

				//Render Obstacle
				renderObstacles();

				//Render Spaceship
				renderSpaceship(spaceshipPos, rows - 3, renderStr);

				//Render Invaders
				renderInvaders(123456, 0, renderStr);

				//Render Bullets
				renderBullets(renderStr);

				//Gesamtergebnis anzeigen
				document.getElementById("console").innerText = renderStr;
			}
		}

		//Es geht los - alle 40 Millisekunden rendern
		newGame();
		setInterval(render, 40)
	</script>
</body>

</html>